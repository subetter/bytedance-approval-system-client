# Approval System Frontend - ç»„ä»¶ååŒå·¥ä½œè¯´æ˜

## ğŸ“‹ ç›®å½•
1. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
2. [çŠ¶æ€ç®¡ç† (Store)](#çŠ¶æ€ç®¡ç†-store)
3. [ç»„ä»¶å±‚çº§ç»“æ„](#ç»„ä»¶å±‚çº§ç»“æ„)
4. [æ•°æ®æµå’Œä¼ å€¼æœºåˆ¶](#æ•°æ®æµå’Œä¼ å€¼æœºåˆ¶)
5. [æ ¸å¿ƒç»„ä»¶é€»è¾‘](#æ ¸å¿ƒç»„ä»¶é€»è¾‘)
6. [ç»„ä»¶äº¤äº’æµç¨‹](#ç»„ä»¶äº¤äº’æµç¨‹)

---

## æ•´ä½“æ¶æ„

### æŠ€æœ¯æ ˆ
- **æ¡†æ¶**: Next.js (App Router)
- **çŠ¶æ€ç®¡ç†**: Zustand
- **UI ç»„ä»¶åº“**: Arco Design
- **æ•°æ®è·å–**: è‡ªå®šä¹‰ API å°è£…

### æ¶æ„æ¨¡å¼
é‡‡ç”¨ **"å®¹å™¨ç»„ä»¶ + å±•ç¤ºç»„ä»¶"** æ¨¡å¼ï¼š
- **page.tsx** ä½œä¸ºå®¹å™¨ç»„ä»¶ï¼Œè´Ÿè´£çŠ¶æ€ç®¡ç†å’Œä¸šåŠ¡é€»è¾‘åè°ƒ
- å…¶ä»–ç»„ä»¶ä½œä¸ºå±•ç¤ºç»„ä»¶ï¼Œé€šè¿‡ props æ¥æ”¶æ•°æ®å’Œå›è°ƒå‡½æ•°

---

## çŠ¶æ€ç®¡ç† (Store)

### 1. useApprovalStore (å®¡æ‰¹å•çŠ¶æ€ç®¡ç†)

**ä½ç½®**: `src/store/useApprovalStore.ts`

**ç®¡ç†çš„æ•°æ®**:
```typescript
{
  approvalList: ApprovalForm[];        // å®¡æ‰¹å•åˆ—è¡¨
  loading: boolean;                     // åŠ è½½çŠ¶æ€
  total: number;                        // æ€»æ•°
  currentPage: number;                  // å½“å‰é¡µç 
  pageSize: number;                     // æ¯é¡µæ•°é‡
  queryParams: Partial<ApprovalFormQueryParams>; // æŸ¥è¯¢å‚æ•°
  departmentOptions: CascaderOption[]; // éƒ¨é—¨é€‰é¡¹ï¼ˆæ ‘å½¢ç»“æ„ï¼‰
  departmentPathMap: Map<string, string>; // éƒ¨é—¨è·¯å¾„æ˜ å°„
  formSchema: FormField[];              // è¡¨å•é…ç½®ï¼ˆåŠ¨æ€å­—æ®µï¼‰
  currentSchemaKey: string;             // å½“å‰è¡¨å•é…ç½® Key
}
```

**æ ¸å¿ƒæ–¹æ³•**:
- `fetchApprovalList()`: è·å–å®¡æ‰¹å•åˆ—è¡¨ï¼ˆä¼šæ ¹æ®å½“å‰è§’è‰²è‡ªåŠ¨è¿‡æ»¤ï¼‰
- `fetchDepartmentOptions()`: è·å–éƒ¨é—¨é€‰é¡¹æ•°æ®
- `fetchFormSchema()`: è·å–è¡¨å•é…ç½®ï¼ˆç”¨äºåŠ¨æ€ç”Ÿæˆè¡¨å•å’Œè¡¨æ ¼åˆ—ï¼‰
- `setQueryParams()`: è®¾ç½®æŸ¥è¯¢å‚æ•°
- `resetQueryParams()`: é‡ç½®æŸ¥è¯¢å‚æ•°

**ç‰¹ç‚¹**:
- ä¸ `useUserRoleStore` è”åŠ¨ï¼Œè·å–åˆ—è¡¨æ—¶ä¼šè‡ªåŠ¨å¸¦ä¸Šå½“å‰è§’è‰²
- éƒ¨é—¨æ•°æ®åªåŠ è½½ä¸€æ¬¡ï¼ˆç¼“å­˜æœºåˆ¶ï¼‰
- è¡¨å•é…ç½®æ”¯æŒåŠ¨æ€åˆ‡æ¢ï¼ˆé€šè¿‡ SchemaConfig ç»„ä»¶ï¼‰

### 2. useUserRoleStore (ç”¨æˆ·è§’è‰²çŠ¶æ€ç®¡ç†)

**ä½ç½®**: `src/store/useUserRoleStore.ts`

**ç®¡ç†çš„æ•°æ®**:
```typescript
{
  currentRole: UserRole;  // å½“å‰è§’è‰²ï¼šAPPLICANT(ç”³è¯·äºº) | APPROVER(å®¡æ‰¹äºº)
  currentUser: User | null; // å½“å‰ç”¨æˆ·ä¿¡æ¯
}
```

**æ ¸å¿ƒæ–¹æ³•**:
- `switchRole()`: åˆ‡æ¢è§’è‰²

**ç‰¹ç‚¹**:
- è§’è‰²åˆ‡æ¢ä¼šè§¦å‘å®¡æ‰¹å•åˆ—è¡¨é‡æ–°åŠ è½½
- ä¸åŒè§’è‰²çœ‹åˆ°ä¸åŒçš„æ“ä½œæŒ‰é’®å’Œæ•°æ®

---

## ç»„ä»¶å±‚çº§ç»“æ„

```
page.tsx (ä¸»å®¹å™¨)
â”œâ”€â”€ NavigationBar (å¯¼èˆªæ )
â”‚   â””â”€â”€ è§’è‰²åˆ‡æ¢ä¸‹æ‹‰èœå•
â”œâ”€â”€ SchemaConfig (è¡¨å•é…ç½®é€‰æ‹©å™¨)
â”œâ”€â”€ FilterPanel (ç­›é€‰é¢æ¿)
â”‚   â””â”€â”€ åŠ¨æ€ç”Ÿæˆç­›é€‰å­—æ®µï¼ˆåŸºäº formSchemaï¼Œæ”¯æŒæŠ˜å /å±•å¼€ï¼‰
â”œâ”€â”€ ActionBar (æ“ä½œæ )
â”‚   â”œâ”€â”€ æ–°å»ºæŒ‰é’® (ä»…ç”³è¯·äººå¯è§)
â”‚   â””â”€â”€ ExcelImport (æ‰¹é‡å¯¼å…¥)
â”œâ”€â”€ ApprovalTable (å®¡æ‰¹å•è¡¨æ ¼)
â”‚   â””â”€â”€ åŠ¨æ€ç”Ÿæˆè¡¨æ ¼åˆ—ï¼ˆåŸºäº formSchemaï¼‰
â”œâ”€â”€ ApprovalModal (æ–°å»º/ç¼–è¾‘å¼¹çª—)
â”‚   â”œâ”€â”€ åŠ¨æ€ç”Ÿæˆè¡¨å•å­—æ®µï¼ˆåŸºäº formSchemaï¼‰
â”‚   â””â”€â”€ ImageUpload (å›¾ç‰‡ä¸Šä¼ ç»„ä»¶)
â”œâ”€â”€ ApprovalDrawer (æŸ¥çœ‹è¯¦æƒ…æŠ½å±‰)
â””â”€â”€ GlobalMessage (å…¨å±€æ¶ˆæ¯æç¤º)
```

---

## æ•°æ®æµå’Œä¼ å€¼æœºåˆ¶

### 1. çŠ¶æ€æå‡ (State Lifting)

**ä¸»é¡µé¢ (page.tsx) ç®¡ç†çš„çŠ¶æ€**:
```typescript
// å¼¹çª—çŠ¶æ€
const [modalVisible, setModalVisible] = useState(false);
const [modalMode, setModalMode] = useState<'create' | 'edit' | 'view'>('create');
const [selectedRecord, setSelectedRecord] = useState<ApprovalForm | undefined>();

// æŠ½å±‰çŠ¶æ€
const [drawerVisible, setDrawerVisible] = useState(false);

// ç¡®è®¤æ“ä½œçŠ¶æ€
const [actionRecord, setActionRecord] = useState<ApprovalForm | null>(null);
const [actionType, setActionType] = useState<'approve' | 'reject' | 'withdraw' | null>(null);

// å…¨å±€æ¶ˆæ¯çŠ¶æ€
const [messageState, setMessageState] = useState<{...}>();
```

### 2. Props ä¼ å€¼

#### å‘ä¸‹ä¼ å€¼ (çˆ¶ â†’ å­)
- **NavigationBar**: `currentRole`, `userName`, `onRoleChange`
- **FilterPanel**: `onSearch`, `onReset`
- **ApprovalTable**: `onView`, `onEdit`, `onApprove`, `onReject`, `onWithdraw`
- **ApprovalModal**: `visible`, `mode`, `record`, `onClose`, `onSuccess`, `showMessage`
- **ApprovalDrawer**: `visible`, `record`, `onClose`
- **ExcelImport**: `onSuccess`, `showMessage`
- **SchemaConfig**: æ—  propsï¼ˆç›´æ¥ä½¿ç”¨ Storeï¼‰

#### å‘ä¸Šä¼ å€¼ (å­ â†’ çˆ¶)
é€šè¿‡ **å›è°ƒå‡½æ•° (Callback)** å®ç°ï¼š
- `onRoleChange`: è§’è‰²åˆ‡æ¢æ—¶è§¦å‘
- `onSearch`: ç­›é€‰æŸ¥è¯¢æ—¶è§¦å‘
- `onView/onEdit/onApprove/onReject/onWithdraw`: è¡¨æ ¼æ“ä½œæ—¶è§¦å‘
- `onSuccess`: æ“ä½œæˆåŠŸæ—¶è§¦å‘ï¼ˆåˆ·æ–°åˆ—è¡¨ï¼‰
- `showMessage`: æ˜¾ç¤ºå…¨å±€æ¶ˆæ¯

### 3. Store å…±äº«çŠ¶æ€

ç»„ä»¶é€šè¿‡ **Zustand hooks** ç›´æ¥è®¿é—®å’Œä¿®æ”¹ Storeï¼š

```typescript
// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
const { 
  approvalList, 
  loading, 
  fetchApprovalList,
  formSchema 
} = useApprovalStore();

const { currentRole, switchRole } = useUserRoleStore();
```

**ä¼˜åŠ¿**:
- é¿å… props drillingï¼ˆé¿å…å±‚å±‚ä¼ é€’ propsï¼‰
- å¤šä¸ªç»„ä»¶å¯ä»¥å…±äº«åŒä¸€ä»½çŠ¶æ€
- çŠ¶æ€æ›´æ–°è‡ªåŠ¨è§¦å‘ç»„ä»¶é‡æ–°æ¸²æŸ“

### 4. æ•°æ®æµå‘å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         page.tsx (å®¹å™¨ç»„ä»¶)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ç®¡ç†æ‰€æœ‰å¼¹çª—/æŠ½å±‰çŠ¶æ€            â”‚   â”‚
â”‚  â”‚  å¤„ç†ä¸šåŠ¡é€»è¾‘å’Œäº‹ä»¶åè°ƒ           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                    â”‚
           â”‚ props              â”‚ Store hooks
           â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å­ç»„ä»¶ (å±•ç¤º)    â”‚    â”‚  Zustand Store   â”‚
â”‚  - NavigationBar â”‚    â”‚  - approvalStore  â”‚
â”‚  - FilterPanel   â”‚    â”‚  - userRoleStore â”‚
â”‚  - ApprovalTable â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  - ApprovalModal â”‚              â”‚
â”‚  - ...           â”‚              â”‚ å…±äº«çŠ¶æ€
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
           â”‚                      â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  API è°ƒç”¨    â”‚
              â”‚  (request)   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒç»„ä»¶é€»è¾‘

### 1. page.tsx (ä¸»å®¹å™¨)

**èŒè´£**:
- ä½œä¸ºæ•´ä¸ªåº”ç”¨çš„åè°ƒä¸­å¿ƒ
- ç®¡ç†æ‰€æœ‰å¼¹çª—ã€æŠ½å±‰çš„æ˜¾ç¤º/éšè—çŠ¶æ€
- å¤„ç†è§’è‰²åˆ‡æ¢ã€æŸ¥è¯¢ã€æ–°å»ºã€ç¼–è¾‘ã€æŸ¥çœ‹ã€å®¡æ‰¹ç­‰æ“ä½œ
- ç»Ÿä¸€ç®¡ç†å…¨å±€æ¶ˆæ¯æç¤º

**å…³é”®é€»è¾‘**:

```typescript
// è§’è‰²åˆ‡æ¢å¤„ç†
const handleRoleChange = (role: UserRole) => {
  switchRole(role);
  resetQueryParams();  // é‡ç½®æŸ¥è¯¢æ¡ä»¶
  fetchApprovalList(); // é‡æ–°è·å–åˆ—è¡¨
};

// æŸ¥è¯¢å¤„ç†
const handleSearch = (params: ApprovalFormQueryParams) => {
  setQueryParams(params);
  fetchApprovalList(params);
};

// æ–°å»ºå®¡æ‰¹å•
const handleCreate = () => {
  setModalMode('create');
  setSelectedRecord(undefined);
  setModalVisible(true);
};

// æŸ¥çœ‹å®¡æ‰¹å•
const handleViewApproval = (record: ApprovalForm) => {
  setSelectedRecord(record);
  setDrawerVisible(true);
};

// ä¿®æ”¹å®¡æ‰¹å•
const handleEditApproval = (record: ApprovalForm) => {
  setModalMode('edit');
  setSelectedRecord(record);
  setModalVisible(true);
};

// å®¡æ‰¹æ“ä½œï¼ˆé€šè¿‡/é©³å›/æ’¤å›ï¼‰
const handleConfirmAction = async () => {
  if (!actionRecord || !actionType) return;

  try {
    // ä½¿ç”¨å·¥å…·å‡½æ•°æ‰§è¡Œæ“ä½œ
    await executeApprovalAction(actionType, actionRecord, currentRole);
    showMessage('success', getApprovalActionSuccessMessage(actionType));
    fetchApprovalList(); // åˆ·æ–°åˆ—è¡¨
    handleCloseConfirm();
  } catch (error) {
    showMessage('error', 'æ“ä½œå¤±è´¥');
  }
};
```

### 2. ApprovalTable (å®¡æ‰¹å•è¡¨æ ¼)

**èŒè´£**:
- å±•ç¤ºå®¡æ‰¹å•åˆ—è¡¨
- æ ¹æ® `formSchema` åŠ¨æ€ç”Ÿæˆè¡¨æ ¼åˆ—
- å¤„ç†åˆ†é¡µ
- è§¦å‘å„ç§æ“ä½œï¼ˆæŸ¥çœ‹ã€ç¼–è¾‘ã€å®¡æ‰¹ç­‰ï¼‰

**å…³é”®é€»è¾‘**:

```typescript
// åŠ¨æ€ç”Ÿæˆåˆ—é…ç½®
const getDynamicColumns = (): TableColumnProps<ApprovalForm>[] => {
  // 1. ç³»ç»Ÿå›ºå®šåˆ—ï¼ˆå·¦ä¾§ï¼‰ï¼šå®¡æ‰¹çŠ¶æ€
  const leftFixedColumns = [...];
  
  // 2. åŠ¨æ€åˆ—ï¼ˆä¸­é—´ï¼‰ï¼šæ ¹æ® formSchema ç”Ÿæˆ
  const dynamicColumns = formSchema.map(field => {
    // ä½¿ç”¨å·¥å…·å‡½æ•°ç”Ÿæˆåˆ—é…ç½®
    const col = generateTableColumn(field, departmentPathMap);
    
    // ç‰¹æ®Šå­—æ®µå¤„ç†ï¼šprojectName è‡ªå®šä¹‰æ¸²æŸ“
    if (field.field === 'projectName') {
      col.render = (projectName) => (
        <div className={styles.projectCell}>
          <div className={styles.projectName}>{projectName}</div>
        </div>
      );
    }
    return col;
  });
  
  // 3. ç³»ç»Ÿå›ºå®šåˆ—ï¼ˆå³ä¾§ï¼‰ï¼šæ“ä½œåˆ—
  const rightFixedColumns = [
    {
      title: 'æ“ä½œ',
      render: (_, record) => (
        // æ ¹æ® currentRole æ˜¾ç¤ºä¸åŒçš„æ“ä½œæŒ‰é’®
        // ç”³è¯·äººï¼šæŸ¥çœ‹ã€ä¿®æ”¹ã€æ’¤å›
        // å®¡æ‰¹äººï¼šæŸ¥çœ‹ã€é€šè¿‡ã€é©³å›
      )
    }
  ];
  
  return [...leftFixedColumns, ...dynamicColumns, ...rightFixedColumns];
};

// åˆ†é¡µå¤„ç†
const handlePageChange = (page: number, pageSize: number) => {
  setCurrentPage(page);
  setPageSize(pageSize);
  fetchApprovalList();
};
```

**æ•°æ®æ¥æº**:
- `approvalList`: ä» `useApprovalStore` è·å–
- `formSchema`: ä» `useApprovalStore` è·å–ï¼ˆç”¨äºåŠ¨æ€ç”Ÿæˆåˆ—ï¼‰
- `departmentPathMap`: ä» `useApprovalStore` è·å–ï¼ˆç”¨äºæ˜¾ç¤ºéƒ¨é—¨è·¯å¾„ï¼‰

### 3. FilterPanel (ç­›é€‰é¢æ¿)

**èŒè´£**:
- æ ¹æ® `formSchema` åŠ¨æ€ç”Ÿæˆç­›é€‰å­—æ®µ
- å¤„ç†æŸ¥è¯¢å’Œé‡ç½®
- æ ¹æ®è§’è‰²è‡ªåŠ¨è®¾ç½®ç­›é€‰æ¡ä»¶ï¼ˆå®¡æ‰¹äººé»˜è®¤åªæ˜¾ç¤ºå¾…å®¡æ‰¹ï¼‰

**å…³é”®é€»è¾‘**:

```typescript
// ç›‘å¬è§’è‰²å˜åŒ–ï¼Œè‡ªåŠ¨è®¾ç½®ç­›é€‰æ¡ä»¶
useEffect(() => {
  if (currentRole === UserRole.APPROVER) {
    form.setFieldValue('status', ApprovalStatus.PENDING);
  } else {
    form.setFieldValue('status', '');
  }
}, [currentRole, form]);

// åŠ¨æ€ç”Ÿæˆç­›é€‰å­—æ®µ
{formSchema.map((field, index) => {
  // å¤„ç†æŠ˜å é€»è¾‘ï¼šæŠ˜å æ—¶åªæ˜¾ç¤ºå‰2ä¸ªåŠ¨æ€å­—æ®µ
  if (collapsed && index >= 2) return null;
  
  // ä½¿ç”¨å·¥å…·å‡½æ•°æ¸²æŸ“ç­›é€‰ç»„ä»¶
  return renderFilterComponent(field, departmentOptions, handleSearch);
})}

// æŸ¥è¯¢å¤„ç†
const handleSearch = () => {
  const values = form.getFieldsValue();
  const queryParams: ApprovalFormQueryParams = {
    // ç³»ç»Ÿå›ºå®šå­—æ®µ
    status: values.status,
    // åŠ¨æ€å­—æ®µæ˜ å°„
    // éƒ¨é—¨ï¼šå–æ•°ç»„æœ€åä¸€ä¸ª ID
    // æ—¥æœŸï¼šè½¬æ¢ä¸ºèŒƒå›´æŸ¥è¯¢å‚æ•°
    // æ–‡æœ¬ï¼šç›´æ¥ä¼ é€’
  };
  onSearch(queryParams);
};
```

### 4. ApprovalModal (æ–°å»º/ç¼–è¾‘å¼¹çª—)

**èŒè´£**:
- æ ¹æ® `formSchema` åŠ¨æ€ç”Ÿæˆè¡¨å•å­—æ®µ
- å¤„ç†æ–°å»ºå’Œç¼–è¾‘ä¸¤ç§æ¨¡å¼
- å¤„ç†å›¾ç‰‡é™„ä»¶ä¸Šä¼ 
- è¡¨å•éªŒè¯å’Œæäº¤

**å…³é”®é€»è¾‘**:

```typescript
// åŠ¨æ€æ¸²æŸ“è¡¨å•å­—æ®µ
const renderFormItem = (field: FormField) => {
  // ç‰¹æ®Šå¤„ç†ï¼šimages å­—æ®µå•ç‹¬æ¸²æŸ“
  if (fieldName === 'images' || fieldName === 'imageAttachments') return null;

  // ä½¿ç”¨å·¥å…·å‡½æ•°ç”Ÿæˆæ ¡éªŒè§„åˆ™
  const rules = generateFormRules(field);
  // ä½¿ç”¨å·¥å…·å‡½æ•°æ¸²æŸ“è¡¨å•ç»„ä»¶
  const formComponent = renderFormComponent(field, departmentOptions);

  return (
    <FormItem key={fieldName} label={name} field={fieldName} rules={rules}>
      {formComponent}
    </FormItem>
  );
};

// è¡¨å•åˆå§‹åŒ–
useEffect(() => {
  if (visible && record && (mode === 'edit' || mode === 'view')) {
    // è®¡ç®—éƒ¨é—¨IDè·¯å¾„ï¼ˆCascader éœ€è¦æ•°ç»„ï¼‰
    const departmentPathIds = getDepartmentIdPath(departmentOptions, record.departmentId);
    
    // åˆå§‹åŒ–é™„ä»¶åˆ—è¡¨ï¼ˆè½¬æ¢ä¸º Upload ç»„ä»¶æ‰€éœ€æ ¼å¼ï¼‰
    const imageFileList = record.attachments?.map(att => ({
      uid: String(att.id),
      name: att.fileName,
      url: att.fileUrl,
      status: 'done',
    })) || [];
    
    form.setFieldsValue({
      ...record,
      departmentId: departmentPathIds,
      executeDate: record.executeDate ? dayjs(record.executeDate) : undefined,
      images: imageFileList,
    });
  }
}, [visible, record, mode, form, departmentOptions]);

// æäº¤å¤„ç†
const handleSubmit = async () => {
  const values = await form.validate();
  
  // æå–éƒ¨é—¨IDï¼ˆCascader è¿”å›æ•°ç»„ï¼Œå–æœ€åä¸€ä¸ªï¼‰
  const departmentId = Array.isArray(values.departmentId)
    ? values.departmentId[values.departmentId.length - 1]
    : values.departmentId;
  
  // æ—¥æœŸè½¬æ¢
  const executeDate = values.executeDate ? dayjs(values.executeDate).format('YYYY-MM-DD') : undefined;
  
  // æå–é™„ä»¶IDåˆ—è¡¨
  const attachmentIds = extractAttachmentIds(values.images);
  
  if (mode === 'create') {
    await createApproval({ ...values, departmentId, executeDate, attachmentIds });
  } else if (mode === 'edit') {
    await updateApproval(record.id, { ...values, departmentId, executeDate, attachmentIds });
  }
  
  fetchApprovalList(); // åˆ·æ–°åˆ—è¡¨
  onSuccess?.();
  onClose();
};
```

### 5. ImageUpload (å›¾ç‰‡ä¸Šä¼ ç»„ä»¶)

**èŒè´£**:
- å¤„ç†å›¾ç‰‡ä¸Šä¼ ï¼ˆæœ€å¤š3å¼ ï¼‰
- å¤„ç†å›¾ç‰‡åˆ é™¤ï¼ˆæ–°å»ºæ¨¡å¼åªå‰ç«¯åˆ é™¤ï¼Œç¼–è¾‘æ¨¡å¼è°ƒç”¨åç«¯åˆ é™¤æ¥å£ï¼‰
- æ›´æ–°æ–‡ä»¶åˆ—è¡¨çŠ¶æ€

**å…³é”®é€»è¾‘**:

```typescript
// ä¸Šä¼ æˆåŠŸå¤„ç†
const handleChange = (fileList: any[], file: any) => {
  if (file.status === 'done' && file.response?.data) {
    const { id, fileUrl } = file.response.data;
    // æ›´æ–°æ–‡ä»¶çš„ uid å’Œ url
    file.uid = String(id);
    file.url = fileUrl;
    // æ›´æ–° fileList
    onChange?.(fileList);
  }
};

// åˆ é™¤å¤„ç†
const handleDelete = (file: any) => {
  // ç¼–è¾‘æ¨¡å¼ï¼šè°ƒç”¨åç«¯åˆ é™¤æ¥å£
  if (formId && file.status === 'done' && file.response?.id) {
    const attachmentId = file.response.id || file.uid;
    deleteAttachment(formId, attachmentId).then(() => {
      showMessage?.('success', 'é™„ä»¶è®°å½•åˆ é™¤æˆåŠŸ');
    });
  }
  // æ–°å»ºæ¨¡å¼ï¼šåªåœ¨å‰ç«¯ç§»é™¤
  return true;
};
```

### 6. ApprovalDrawer (æŸ¥çœ‹è¯¦æƒ…æŠ½å±‰)

**èŒè´£**:
- åªè¯»å±•ç¤ºå®¡æ‰¹å•è¯¦æƒ…
- æ˜¾ç¤ºé™„ä»¶é¢„è§ˆ

**ç‰¹ç‚¹**:
- çº¯å±•ç¤ºç»„ä»¶ï¼Œæ— ä¸šåŠ¡é€»è¾‘
- é€šè¿‡ props æ¥æ”¶ `record` æ•°æ®

### 7. ExcelImport (æ‰¹é‡å¯¼å…¥)

**èŒè´£**:
- è§£æ Excel æ–‡ä»¶
- æ‰¹é‡åˆ›å»ºå®¡æ‰¹å•
- å¤„ç†éƒ¨é—¨åç§°åˆ° ID çš„è½¬æ¢

**å…³é”®é€»è¾‘**:

```typescript
// ä¸‹è½½æ¨¡æ¿
const downloadTemplate = () => {
  // ä½¿ç”¨ xlsx åº“ç”ŸæˆåŒ…å«ç¤ºä¾‹æ•°æ®çš„æ¨¡æ¿
  const wb = XLSX.utils.book_new();
  const headers = ['å®¡æ‰¹é¡¹ç›®', 'å®¡æ‰¹å†…å®¹', 'ç”³è¯·éƒ¨é—¨', 'æ‰§è¡Œæ—¥æœŸ'];
  const data = ['ç¤ºä¾‹é¡¹ç›®...', ...];
  // ... ç”Ÿæˆå¹¶ä¸‹è½½æ–‡ä»¶
};

const handleExcelUpload = async (option: any) => {
  // 1. è¯»å– Excel æ–‡ä»¶
  const workbook = XLSX.read(data, { type: 'binary' });
  const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
  
  // 2. éªŒè¯æ ¼å¼
  const headers = json[0];
  const expectedHeaders = ['å®¡æ‰¹é¡¹ç›®', 'å®¡æ‰¹å†…å®¹', 'ç”³è¯·éƒ¨é—¨', 'æ‰§è¡Œæ—¥æœŸ'];
  
  // 3. è§£ææ•°æ®å¹¶è½¬æ¢éƒ¨é—¨åç§°åˆ° ID
  const approvals = await Promise.all(
    rows.map(async (row) => {
      const departmentName = row[2];
      const res = await fetchDepartmentsByName(departmentName);
      return {
        projectName: row[0],
        content: row[1],
        departmentId: res.data.id,
        executeDate: row[3],
      };
    })
  );
  
  // 4. æ‰¹é‡åˆ›å»º
  await batchCreateApprovals(approvals);
  onSuccess?.(); // åˆ·æ–°åˆ—è¡¨
};
```

### 8. SchemaConfig (è¡¨å•é…ç½®é€‰æ‹©å™¨)

**èŒè´£**:
- åˆ‡æ¢ä¸åŒçš„è¡¨å•é…ç½®ï¼ˆbasic_approval, no_time_version_approval, simple_approvalï¼‰
- è§¦å‘è¡¨å•é…ç½®é‡æ–°åŠ è½½

**å…³é”®é€»è¾‘**:

```typescript
const handleChange = async (value: string) => {
  await fetchFormSchema(value); // æ›´æ–° Store ä¸­çš„ formSchema
  // è¡¨æ ¼åˆ—å’Œè¡¨å•å­—æ®µä¼šè‡ªåŠ¨æ›´æ–°ï¼ˆå› ä¸ºå®ƒä»¬ä¾èµ– formSchemaï¼‰
};
```

---

## ç»„ä»¶äº¤äº’æµç¨‹

### 1. è§’è‰²åˆ‡æ¢æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»è§’è‰²åˆ‡æ¢
    â†“
NavigationBar.onRoleChange()
    â†“
page.tsx.handleRoleChange()
    â†“
useUserRoleStore.switchRole()  // æ›´æ–°è§’è‰²
    â†“
useApprovalStore.resetQueryParams()  // é‡ç½®æŸ¥è¯¢æ¡ä»¶
    â†“
useApprovalStore.fetchApprovalList()  // é‡æ–°è·å–åˆ—è¡¨ï¼ˆå¸¦ä¸Šæ–°è§’è‰²ï¼‰
    â†“
API è°ƒç”¨: GET /approvals?role=APPROVER
    â†“
æ›´æ–° approvalList
    â†“
ApprovalTable é‡æ–°æ¸²æŸ“ï¼ˆæ˜¾ç¤ºæ–°è§’è‰²çš„æ•°æ®ï¼‰
FilterPanel è‡ªåŠ¨è®¾ç½®ç­›é€‰æ¡ä»¶ï¼ˆå®¡æ‰¹äººé»˜è®¤å¾…å®¡æ‰¹ï¼‰
```

### 2. æŸ¥è¯¢æµç¨‹

```
ç”¨æˆ·åœ¨ FilterPanel è¾“å…¥ç­›é€‰æ¡ä»¶
    â†“
ç‚¹å‡»"æŸ¥è¯¢"æŒ‰é’®
    â†“
FilterPanel.handleSearch()
    â†“
æ„å»º queryParamsï¼ˆåŒ…å«åŠ¨æ€å­—æ®µæ˜ å°„ï¼‰
    â†“
è°ƒç”¨ onSearch(queryParams)
    â†“
page.tsx.handleSearch()
    â†“
useApprovalStore.setQueryParams()  // ä¿å­˜æŸ¥è¯¢å‚æ•°
    â†“
useApprovalStore.fetchApprovalList(params)  // å¸¦ä¸ŠæŸ¥è¯¢å‚æ•°è·å–åˆ—è¡¨
    â†“
API è°ƒç”¨: GET /approvals?status=PENDING&departmentId=1&...
    â†“
æ›´æ–° approvalList
    â†“
ApprovalTable é‡æ–°æ¸²æŸ“ï¼ˆæ˜¾ç¤ºç­›é€‰åçš„æ•°æ®ï¼‰
```

### 3. æ–°å»ºå®¡æ‰¹å•æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"æ–°å»º"æŒ‰é’®
    â†“
page.tsx.handleCreate()
    â†“
è®¾ç½® modalMode='create', modalVisible=true
    â†“
ApprovalModal æ˜¾ç¤ºï¼ˆç©ºè¡¨å•ï¼‰
    â†“
ç”¨æˆ·å¡«å†™è¡¨å•ï¼ˆåŠ¨æ€å­—æ®µ + å›¾ç‰‡ä¸Šä¼ ï¼‰
    â†“
ç‚¹å‡»"æäº¤"
    â†“
ApprovalModal.handleSubmit()
    â†“
è¡¨å•éªŒè¯
    â†“
æå–æ•°æ®ï¼ˆéƒ¨é—¨IDã€æ—¥æœŸã€é™„ä»¶IDåˆ—è¡¨ï¼‰
    â†“
API è°ƒç”¨: POST /approvals
    â†“
æˆåŠŸå›è°ƒ
    â†“
useApprovalStore.fetchApprovalList()  // åˆ·æ–°åˆ—è¡¨
    â†“
page.tsx.handleModalSuccess()
    â†“
å…³é—­å¼¹çª—
    â†“
æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
```

### 4. ç¼–è¾‘å®¡æ‰¹å•æµç¨‹

```
ç”¨æˆ·åœ¨è¡¨æ ¼ç‚¹å‡»"ä¿®æ”¹"æŒ‰é’®
    â†“
ApprovalTable.handleEdit()
    â†“
è°ƒç”¨ onEdit(record)
    â†“
page.tsx.handleEditApproval(record)
    â†“
è®¾ç½® modalMode='edit', selectedRecord=record, modalVisible=true
    â†“
ApprovalModal æ˜¾ç¤ºï¼ˆé¢„å¡«å……è¡¨å•ï¼‰
    â†“
useEffect åˆå§‹åŒ–è¡¨å•æ•°æ®ï¼ˆéƒ¨é—¨è·¯å¾„ã€é™„ä»¶åˆ—è¡¨ç­‰ï¼‰
    â†“
ç”¨æˆ·ä¿®æ”¹è¡¨å•
    â†“
ç‚¹å‡»"ä¿å­˜"
    â†“
API è°ƒç”¨: PUT /approvals/:id
    â†“
åˆ·æ–°åˆ—è¡¨ + å…³é—­å¼¹çª—
```

### 5. æŸ¥çœ‹å®¡æ‰¹å•æµç¨‹

```
ç”¨æˆ·åœ¨è¡¨æ ¼ç‚¹å‡»"æŸ¥çœ‹"æŒ‰é’®
    â†“
ApprovalTable.handleView()
    â†“
è°ƒç”¨ onView(record)
    â†“
page.tsx.handleViewApproval(record)
    â†“
è®¾ç½® selectedRecord=record, drawerVisible=true
    â†“
ApprovalDrawer æ˜¾ç¤ºï¼ˆåªè¯»å±•ç¤ºï¼‰
```

### 6. å®¡æ‰¹æ“ä½œæµç¨‹ï¼ˆé€šè¿‡/é©³å›/æ’¤å›ï¼‰

```
ç”¨æˆ·åœ¨è¡¨æ ¼ç‚¹å‡»"é€šè¿‡"/"é©³å›"/"æ’¤å›"æŒ‰é’®
    â†“
ApprovalTable.handleApprove/Reject/Withdraw()
    â†“
è°ƒç”¨ onApprove/onReject/onWithdraw(record)
    â†“
page.tsx.handleApprove/Reject/Withdraw(record)
    â†“
è®¾ç½® actionRecord=record, actionType='approve'/'reject'/'withdraw'
    â†“
æ˜¾ç¤ºç¡®è®¤å¼¹çª—ï¼ˆModalï¼‰
    â†“
ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤"
    â†“
page.tsx.handleConfirmAction()
    â†“
API è°ƒç”¨: POST /approvals/:id/approve|reject|withdraw
    â†“
åˆ·æ–°åˆ—è¡¨
    â†“
å…³é—­ç¡®è®¤å¼¹çª—
    â†“
æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
```

### 7. åŠ¨æ€è¡¨å•/è¡¨æ ¼ç”Ÿæˆæµç¨‹

```
åº”ç”¨å¯åŠ¨ / SchemaConfig åˆ‡æ¢é…ç½®
    â†“
useApprovalStore.fetchFormSchema(key)
    â†“
API è°ƒç”¨: GET /form-schema?key=basic_approval
    â†“
æ›´æ–° formSchema åˆ° Store
    â†“
ApprovalTable.useEffect ç›‘å¬ formSchema å˜åŒ–
    â†“
getDynamicColumns() é‡æ–°ç”Ÿæˆåˆ—é…ç½®
    â†“
è¡¨æ ¼é‡æ–°æ¸²æŸ“ï¼ˆæ˜¾ç¤ºæ–°çš„åˆ—ï¼‰
    â†“
FilterPanel ç›‘å¬ formSchema å˜åŒ–
    â†“
é‡æ–°æ¸²æŸ“ç­›é€‰å­—æ®µ
    â†“
ApprovalModal ç›‘å¬ formSchema å˜åŒ–
    â†“
é‡æ–°æ¸²æŸ“è¡¨å•å­—æ®µ
```

---

## å…³é”®è®¾è®¡æ¨¡å¼

### 1. åŠ¨æ€é…ç½®é©±åŠ¨
- **formSchema** ä½œä¸ºå•ä¸€æ•°æ®æºï¼Œé©±åŠ¨è¡¨æ ¼åˆ—ã€ç­›é€‰å­—æ®µã€è¡¨å•å­—æ®µçš„ç”Ÿæˆ
- æ”¯æŒè¿è¡Œæ—¶åˆ‡æ¢é…ç½®ï¼Œæ— éœ€ä¿®æ”¹ä»£ç 

### 2. çŠ¶æ€é›†ä¸­ç®¡ç†
- ä½¿ç”¨ Zustand Store é›†ä¸­ç®¡ç†å…¨å±€çŠ¶æ€
- é¿å… props drillingï¼Œæé«˜å¯ç»´æŠ¤æ€§

### 3. å®¹å™¨ç»„ä»¶æ¨¡å¼
- page.tsx ä½œä¸ºå®¹å™¨ï¼Œç®¡ç†æ‰€æœ‰å¼¹çª—/æŠ½å±‰çŠ¶æ€
- å­ç»„ä»¶åªè´Ÿè´£å±•ç¤ºå’Œè§¦å‘äº‹ä»¶

### 4. å›è°ƒå‡½æ•°é€šä¿¡
- å­ç»„ä»¶é€šè¿‡å›è°ƒå‡½æ•°é€šçŸ¥çˆ¶ç»„ä»¶
- çˆ¶ç»„ä»¶é€šè¿‡ props ä¼ é€’æ•°æ®å’Œå›è°ƒ

### 5. è§’è‰²é©±åŠ¨ UI
- æ ¹æ® `currentRole` æ˜¾ç¤ºä¸åŒçš„æ“ä½œæŒ‰é’®
- ä¸åŒè§’è‰²çœ‹åˆ°ä¸åŒçš„æ•°æ®ï¼ˆåç«¯è¿‡æ»¤ï¼‰

---

## æ€»ç»“

### æ•°æ®æµç‰¹ç‚¹
1. **å•å‘æ•°æ®æµ**: Store â†’ ç»„ä»¶ â†’ ç”¨æˆ·æ“ä½œ â†’ å›è°ƒ â†’ æ›´æ–° Store
2. **çŠ¶æ€æå‡**: å¼¹çª—/æŠ½å±‰çŠ¶æ€åœ¨ page.tsx ç»Ÿä¸€ç®¡ç†
3. **å…±äº«çŠ¶æ€**: é€šè¿‡ Zustand Store å®ç°è·¨ç»„ä»¶çŠ¶æ€å…±äº«

### ç»„ä»¶èŒè´£åˆ’åˆ†
- **page.tsx**: ä¸šåŠ¡é€»è¾‘åè°ƒã€çŠ¶æ€ç®¡ç†
- **Table/Modal/Drawer**: æ•°æ®å±•ç¤ºå’Œç”¨æˆ·äº¤äº’
- **Store**: æ•°æ®ç®¡ç†å’Œ API è°ƒç”¨
- **API**: æ•°æ®è·å–å’Œæäº¤

### æ‰©å±•æ€§
- é€šè¿‡ `formSchema` å®ç°åŠ¨æ€è¡¨å•/è¡¨æ ¼ï¼Œæ˜“äºæ‰©å±•æ–°å­—æ®µ
- é€šè¿‡ `SchemaConfig` æ”¯æŒå¤šå¥—è¡¨å•é…ç½®
- ç»„ä»¶èŒè´£æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•

