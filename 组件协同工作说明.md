# Approval System Frontend - 组件协同工作说明

## 📋 目录
1. [整体架构](#整体架构)
2. [状态管理 (Store)](#状态管理-store)
3. [组件层级结构](#组件层级结构)
4. [数据流和传值机制](#数据流和传值机制)
5. [核心组件逻辑](#核心组件逻辑)
6. [组件交互流程](#组件交互流程)

---

## 整体架构

### 技术栈
- **框架**: Next.js (App Router)
- **状态管理**: Zustand
- **UI 组件库**: Arco Design
- **数据获取**: 自定义 API 封装

### 架构模式
采用 **"容器组件 + 展示组件"** 模式：
- **page.tsx** 作为容器组件，负责状态管理和业务逻辑协调
- 其他组件作为展示组件，通过 props 接收数据和回调函数

---

## 状态管理 (Store)

### 1. useApprovalStore (审批单状态管理)

**位置**: `src/store/useApprovalStore.ts`

**管理的数据**:
```typescript
{
  approvalList: ApprovalForm[];        // 审批单列表
  loading: boolean;                     // 加载状态
  total: number;                        // 总数
  currentPage: number;                  // 当前页码
  pageSize: number;                     // 每页数量
  queryParams: Partial<ApprovalFormQueryParams>; // 查询参数
  departmentOptions: CascaderOption[]; // 部门选项（树形结构）
  departmentPathMap: Map<string, string>; // 部门路径映射
  formSchema: FormField[];              // 表单配置（动态字段）
  currentSchemaKey: string;             // 当前表单配置 Key
}
```

**核心方法**:
- `fetchApprovalList()`: 获取审批单列表（会根据当前角色自动过滤）
- `fetchDepartmentOptions()`: 获取部门选项数据
- `fetchFormSchema()`: 获取表单配置（用于动态生成表单和表格列）
- `setQueryParams()`: 设置查询参数
- `resetQueryParams()`: 重置查询参数

**特点**:
- 与 `useUserRoleStore` 联动，获取列表时会自动带上当前角色
- 部门数据只加载一次（缓存机制）
- 表单配置支持动态切换（通过 SchemaConfig 组件）

### 2. useUserRoleStore (用户角色状态管理)

**位置**: `src/store/useUserRoleStore.ts`

**管理的数据**:
```typescript
{
  currentRole: UserRole;  // 当前角色：APPLICANT(申请人) | APPROVER(审批人)
  currentUser: User | null; // 当前用户信息
}
```

**核心方法**:
- `switchRole()`: 切换角色

**特点**:
- 角色切换会触发审批单列表重新加载
- 不同角色看到不同的操作按钮和数据

---

## 组件层级结构

```
page.tsx (主容器)
├── NavigationBar (导航栏)
│   └── 角色切换下拉菜单
├── FilterPanel (筛选面板)
│   └── 动态生成筛选字段（基于 formSchema）
├── ActionBar (操作栏)
│   ├── 新建按钮 (仅申请人可见)
│   ├── ExcelImport (批量导入)
│   └── SchemaConfig (表单配置选择器)
├── ApprovalTable (审批单表格)
│   └── 动态生成表格列（基于 formSchema）
├── ApprovalModal (新建/编辑弹窗)
│   ├── 动态生成表单字段（基于 formSchema）
│   └── ImageUpload (图片上传组件)
├── ApprovalDrawer (查看详情抽屉)
└── GlobalMessage (全局消息提示)
```

---

## 数据流和传值机制

### 1. 状态提升 (State Lifting)

**主页面 (page.tsx) 管理的状态**:
```typescript
// 弹窗状态
const [modalVisible, setModalVisible] = useState(false);
const [modalMode, setModalMode] = useState<'create' | 'edit' | 'view'>('create');
const [selectedRecord, setSelectedRecord] = useState<ApprovalForm | undefined>();

// 抽屉状态
const [drawerVisible, setDrawerVisible] = useState(false);

// 确认操作状态
const [actionRecord, setActionRecord] = useState<ApprovalForm | null>(null);
const [actionType, setActionType] = useState<'approve' | 'reject' | 'withdraw' | null>(null);

// 全局消息状态
const [messageState, setMessageState] = useState<{...}>();
```

### 2. Props 传值

#### 向下传值 (父 → 子)
- **NavigationBar**: `currentRole`, `userName`, `onRoleChange`
- **FilterPanel**: `onSearch`, `onReset`
- **ApprovalTable**: `onView`, `onEdit`, `onApprove`, `onReject`, `onWithdraw`
- **ApprovalModal**: `visible`, `mode`, `record`, `onClose`, `onSuccess`, `showMessage`
- **ApprovalDrawer**: `visible`, `record`, `onClose`
- **ExcelImport**: `onSuccess`, `showMessage`
- **SchemaConfig**: 无 props（直接使用 Store）

#### 向上传值 (子 → 父)
通过 **回调函数 (Callback)** 实现：
- `onRoleChange`: 角色切换时触发
- `onSearch`: 筛选查询时触发
- `onView/onEdit/onApprove/onReject/onWithdraw`: 表格操作时触发
- `onSuccess`: 操作成功时触发（刷新列表）
- `showMessage`: 显示全局消息

### 3. Store 共享状态

组件通过 **Zustand hooks** 直接访问和修改 Store：

```typescript
// 在组件中使用
const { 
  approvalList, 
  loading, 
  fetchApprovalList,
  formSchema 
} = useApprovalStore();

const { currentRole, switchRole } = useUserRoleStore();
```

**优势**:
- 避免 props drilling（避免层层传递 props）
- 多个组件可以共享同一份状态
- 状态更新自动触发组件重新渲染

### 4. 数据流向图

```
┌─────────────────────────────────────────┐
│         page.tsx (容器组件)              │
│  ┌──────────────────────────────────┐   │
│  │  管理所有弹窗/抽屉状态            │   │
│  │  处理业务逻辑和事件协调           │   │
│  └──────────────────────────────────┘   │
└─────────────────────────────────────────┘
           │                    │
           │ props              │ Store hooks
           ▼                    ▼
┌──────────────────┐    ┌──────────────────┐
│  子组件 (展示)    │    │  Zustand Store   │
│  - NavigationBar │    │  - approvalStore  │
│  - FilterPanel   │    │  - userRoleStore │
│  - ApprovalTable │    └──────────────────┘
│  - ApprovalModal │              │
│  - ...           │              │ 共享状态
└──────────────────┘              │
           │                      │
           └──────────┬───────────┘
                      │
                      ▼
              ┌──────────────┐
              │  API 调用    │
              │  (request)   │
              └──────────────┘
```

---

## 核心组件逻辑

### 1. page.tsx (主容器)

**职责**:
- 作为整个应用的协调中心
- 管理所有弹窗、抽屉的显示/隐藏状态
- 处理角色切换、查询、新建、编辑、查看、审批等操作
- 统一管理全局消息提示

**关键逻辑**:

```typescript
// 角色切换处理
const handleRoleChange = (role: UserRole) => {
  switchRole(role);
  resetQueryParams();  // 重置查询条件
  fetchApprovalList(); // 重新获取列表
};

// 查询处理
const handleSearch = (params: ApprovalFormQueryParams) => {
  setQueryParams(params);
  fetchApprovalList(params);
};

// 新建审批单
const handleCreate = () => {
  setModalMode('create');
  setSelectedRecord(undefined);
  setModalVisible(true);
};

// 查看审批单
const handleViewApproval = (record: ApprovalForm) => {
  setSelectedRecord(record);
  setDrawerVisible(true);
};

// 修改审批单
const handleEditApproval = (record: ApprovalForm) => {
  setModalMode('edit');
  setSelectedRecord(record);
  setModalVisible(true);
};

// 审批操作（通过/驳回/撤回）
const handleConfirmAction = async () => {
  // 调用对应的 API
  // 刷新列表
  // 显示消息
};
```

### 2. ApprovalTable (审批单表格)

**职责**:
- 展示审批单列表
- 根据 `formSchema` 动态生成表格列
- 处理分页
- 触发各种操作（查看、编辑、审批等）

**关键逻辑**:

```typescript
// 动态生成列配置
const getDynamicColumns = (): TableColumnProps<ApprovalForm>[] => {
  // 1. 系统固定列（左侧）：审批状态
  const leftFixedColumns = [...];
  
  // 2. 动态列（中间）：根据 formSchema 生成
  const dynamicColumns = formSchema.map(field => {
    // 根据 field.component 决定渲染方式
    // 特殊字段处理：departmentId, executeDate, projectName 等
  });
  
  // 3. 系统固定列（右侧）：操作列
  const rightFixedColumns = [
    {
      title: '操作',
      render: (_, record) => (
        // 根据 currentRole 显示不同的操作按钮
        // 申请人：查看、修改、撤回
        // 审批人：查看、通过、驳回
      )
    }
  ];
  
  return [...leftFixedColumns, ...dynamicColumns, ...rightFixedColumns];
};

// 分页处理
const handlePageChange = (page: number, pageSize: number) => {
  setCurrentPage(page);
  setPageSize(pageSize);
  fetchApprovalList();
};
```

**数据来源**:
- `approvalList`: 从 `useApprovalStore` 获取
- `formSchema`: 从 `useApprovalStore` 获取（用于动态生成列）
- `departmentPathMap`: 从 `useApprovalStore` 获取（用于显示部门路径）

### 3. FilterPanel (筛选面板)

**职责**:
- 根据 `formSchema` 动态生成筛选字段
- 处理查询和重置
- 根据角色自动设置筛选条件（审批人默认只显示待审批）

**关键逻辑**:

```typescript
// 监听角色变化，自动设置筛选条件
useEffect(() => {
  if (currentRole === UserRole.APPROVER) {
    form.setFieldValue('status', ApprovalStatus.PENDING);
  } else {
    form.setFieldValue('status', '');
  }
}, [currentRole, form]);

// 动态生成筛选字段
{formSchema.map((field, index) => {
  // 根据 field.component 渲染不同的输入组件
  // Input/Textarea -> Input
  // Cascader -> Cascader (部门选择)
  // DatePicker -> RangePicker (日期范围)
  // DateTimePicker -> RangePicker (日期时间范围)
})}

// 查询处理
const handleSearch = () => {
  const values = form.getFieldsValue();
  const queryParams: ApprovalFormQueryParams = {
    // 系统固定字段
    status: values.status,
    // 动态字段映射
    // 部门：取数组最后一个 ID
    // 日期：转换为范围查询参数
    // 文本：直接传递
  };
  onSearch(queryParams);
};
```

### 4. ApprovalModal (新建/编辑弹窗)

**职责**:
- 根据 `formSchema` 动态生成表单字段
- 处理新建和编辑两种模式
- 处理图片附件上传
- 表单验证和提交

**关键逻辑**:

```typescript
// 动态渲染表单字段
const renderFormItem = (field: FormField) => {
  // 根据 field.component 渲染不同的表单组件
  // Input -> Input
  // Textarea -> TextArea
  // Cascader -> Cascader (部门选择)
  // DatePicker -> DatePicker
  // DateTimePicker -> DatePicker (带时间)
  
  // 特殊处理：images 字段单独渲染，使用 ImageUpload 组件
  if (fieldName === 'images') return null;
};

// 表单初始化
useEffect(() => {
  if (visible && record && (mode === 'edit' || mode === 'view')) {
    // 计算部门ID路径（Cascader 需要数组）
    const departmentPathIds = getDepartmentIdPath(departmentOptions, record.departmentId);
    
    // 初始化附件列表（转换为 Upload 组件所需格式）
    const imageFileList = record.attachments?.map(att => ({
      uid: String(att.id),
      name: att.fileName,
      url: att.fileUrl,
      status: 'done',
    })) || [];
    
    form.setFieldsValue({
      ...record,
      departmentId: departmentPathIds,
      executeDate: record.executeDate ? dayjs(record.executeDate) : undefined,
      images: imageFileList,
    });
  }
}, [visible, record, mode, form, departmentOptions]);

// 提交处理
const handleSubmit = async () => {
  const values = await form.validate();
  
  // 提取部门ID（Cascader 返回数组，取最后一个）
  const departmentId = Array.isArray(values.departmentId)
    ? values.departmentId[values.departmentId.length - 1]
    : values.departmentId;
  
  // 日期转换
  const executeDate = values.executeDate ? dayjs(values.executeDate).format('YYYY-MM-DD') : undefined;
  
  // 提取附件ID列表
  const attachmentIds = extractAttachmentIds(values.images);
  
  if (mode === 'create') {
    await createApproval({ ...values, departmentId, executeDate, attachmentIds });
  } else if (mode === 'edit') {
    await updateApproval(record.id, { ...values, departmentId, executeDate, attachmentIds });
  }
  
  fetchApprovalList(); // 刷新列表
  onSuccess?.();
  onClose();
};
```

### 5. ImageUpload (图片上传组件)

**职责**:
- 处理图片上传（最多3张）
- 处理图片删除（新建模式只前端删除，编辑模式调用后端删除接口）
- 更新文件列表状态

**关键逻辑**:

```typescript
// 上传成功处理
const handleChange = (fileList: any[], file: any) => {
  if (file.status === 'done' && file.response?.data) {
    const { id, fileUrl } = file.response.data;
    // 更新文件的 uid 和 url
    file.uid = String(id);
    file.url = fileUrl;
    // 更新 fileList
    onChange?.(fileList);
  }
};

// 删除处理
const handleDelete = (file: any) => {
  // 编辑模式：调用后端删除接口
  if (formId && file.status === 'done' && file.response?.id) {
    const attachmentId = file.response.id || file.uid;
    deleteAttachment(formId, attachmentId).then(() => {
      showMessage?.('success', '附件记录删除成功');
    });
  }
  // 新建模式：只在前端移除
  return true;
};
```

### 6. ApprovalDrawer (查看详情抽屉)

**职责**:
- 只读展示审批单详情
- 显示附件预览

**特点**:
- 纯展示组件，无业务逻辑
- 通过 props 接收 `record` 数据

### 7. ExcelImport (批量导入)

**职责**:
- 解析 Excel 文件
- 批量创建审批单
- 处理部门名称到 ID 的转换

**关键逻辑**:

```typescript
const handleExcelUpload = async (option: any) => {
  // 1. 读取 Excel 文件
  const workbook = XLSX.read(data, { type: 'binary' });
  const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
  
  // 2. 验证格式
  const headers = json[0];
  const expectedHeaders = ['审批项目', '审批内容', '申请部门', '执行日期'];
  
  // 3. 解析数据并转换部门名称到 ID
  const approvals = await Promise.all(
    rows.map(async (row) => {
      const departmentName = row[2];
      const res = await fetchDepartmentsByName(departmentName);
      return {
        projectName: row[0],
        content: row[1],
        departmentId: res.data.id,
        executeDate: row[3],
      };
    })
  );
  
  // 4. 批量创建
  await batchCreateApprovals(approvals);
  onSuccess?.(); // 刷新列表
};
```

### 8. SchemaConfig (表单配置选择器)

**职责**:
- 切换不同的表单配置（basic_approval, no_time_version_approval, simple_approval）
- 触发表单配置重新加载

**关键逻辑**:

```typescript
const handleChange = async (value: string) => {
  await fetchFormSchema(value); // 更新 Store 中的 formSchema
  // 表格列和表单字段会自动更新（因为它们依赖 formSchema）
};
```

---

## 组件交互流程

### 1. 角色切换流程

```
用户点击角色切换
    ↓
NavigationBar.onRoleChange()
    ↓
page.tsx.handleRoleChange()
    ↓
useUserRoleStore.switchRole()  // 更新角色
    ↓
useApprovalStore.resetQueryParams()  // 重置查询条件
    ↓
useApprovalStore.fetchApprovalList()  // 重新获取列表（带上新角色）
    ↓
API 调用: GET /approvals?role=APPROVER
    ↓
更新 approvalList
    ↓
ApprovalTable 重新渲染（显示新角色的数据）
FilterPanel 自动设置筛选条件（审批人默认待审批）
```

### 2. 查询流程

```
用户在 FilterPanel 输入筛选条件
    ↓
点击"查询"按钮
    ↓
FilterPanel.handleSearch()
    ↓
构建 queryParams（包含动态字段映射）
    ↓
调用 onSearch(queryParams)
    ↓
page.tsx.handleSearch()
    ↓
useApprovalStore.setQueryParams()  // 保存查询参数
    ↓
useApprovalStore.fetchApprovalList(params)  // 带上查询参数获取列表
    ↓
API 调用: GET /approvals?status=PENDING&departmentId=1&...
    ↓
更新 approvalList
    ↓
ApprovalTable 重新渲染（显示筛选后的数据）
```

### 3. 新建审批单流程

```
用户点击"新建"按钮
    ↓
page.tsx.handleCreate()
    ↓
设置 modalMode='create', modalVisible=true
    ↓
ApprovalModal 显示（空表单）
    ↓
用户填写表单（动态字段 + 图片上传）
    ↓
点击"提交"
    ↓
ApprovalModal.handleSubmit()
    ↓
表单验证
    ↓
提取数据（部门ID、日期、附件ID列表）
    ↓
API 调用: POST /approvals
    ↓
成功回调
    ↓
useApprovalStore.fetchApprovalList()  // 刷新列表
    ↓
page.tsx.handleModalSuccess()
    ↓
关闭弹窗
    ↓
显示成功消息
```

### 4. 编辑审批单流程

```
用户在表格点击"修改"按钮
    ↓
ApprovalTable.handleEdit()
    ↓
调用 onEdit(record)
    ↓
page.tsx.handleEditApproval(record)
    ↓
设置 modalMode='edit', selectedRecord=record, modalVisible=true
    ↓
ApprovalModal 显示（预填充表单）
    ↓
useEffect 初始化表单数据（部门路径、附件列表等）
    ↓
用户修改表单
    ↓
点击"保存"
    ↓
API 调用: PUT /approvals/:id
    ↓
刷新列表 + 关闭弹窗
```

### 5. 查看审批单流程

```
用户在表格点击"查看"按钮
    ↓
ApprovalTable.handleView()
    ↓
调用 onView(record)
    ↓
page.tsx.handleViewApproval(record)
    ↓
设置 selectedRecord=record, drawerVisible=true
    ↓
ApprovalDrawer 显示（只读展示）
```

### 6. 审批操作流程（通过/驳回/撤回）

```
用户在表格点击"通过"/"驳回"/"撤回"按钮
    ↓
ApprovalTable.handleApprove/Reject/Withdraw()
    ↓
调用 onApprove/onReject/onWithdraw(record)
    ↓
page.tsx.handleApprove/Reject/Withdraw(record)
    ↓
设置 actionRecord=record, actionType='approve'/'reject'/'withdraw'
    ↓
显示确认弹窗（Modal）
    ↓
用户点击"确认"
    ↓
page.tsx.handleConfirmAction()
    ↓
API 调用: POST /approvals/:id/approve|reject|withdraw
    ↓
刷新列表
    ↓
关闭确认弹窗
    ↓
显示成功消息
```

### 7. 动态表单/表格生成流程

```
应用启动 / SchemaConfig 切换配置
    ↓
useApprovalStore.fetchFormSchema(key)
    ↓
API 调用: GET /form-schema?key=basic_approval
    ↓
更新 formSchema 到 Store
    ↓
ApprovalTable.useEffect 监听 formSchema 变化
    ↓
getDynamicColumns() 重新生成列配置
    ↓
表格重新渲染（显示新的列）
    ↓
FilterPanel 监听 formSchema 变化
    ↓
重新渲染筛选字段
    ↓
ApprovalModal 监听 formSchema 变化
    ↓
重新渲染表单字段
```

---

## 关键设计模式

### 1. 动态配置驱动
- **formSchema** 作为单一数据源，驱动表格列、筛选字段、表单字段的生成
- 支持运行时切换配置，无需修改代码

### 2. 状态集中管理
- 使用 Zustand Store 集中管理全局状态
- 避免 props drilling，提高可维护性

### 3. 容器组件模式
- page.tsx 作为容器，管理所有弹窗/抽屉状态
- 子组件只负责展示和触发事件

### 4. 回调函数通信
- 子组件通过回调函数通知父组件
- 父组件通过 props 传递数据和回调

### 5. 角色驱动 UI
- 根据 `currentRole` 显示不同的操作按钮
- 不同角色看到不同的数据（后端过滤）

---

## 总结

### 数据流特点
1. **单向数据流**: Store → 组件 → 用户操作 → 回调 → 更新 Store
2. **状态提升**: 弹窗/抽屉状态在 page.tsx 统一管理
3. **共享状态**: 通过 Zustand Store 实现跨组件状态共享

### 组件职责划分
- **page.tsx**: 业务逻辑协调、状态管理
- **Table/Modal/Drawer**: 数据展示和用户交互
- **Store**: 数据管理和 API 调用
- **API**: 数据获取和提交

### 扩展性
- 通过 `formSchema` 实现动态表单/表格，易于扩展新字段
- 通过 `SchemaConfig` 支持多套表单配置
- 组件职责清晰，易于维护和扩展

